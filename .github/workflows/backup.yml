name: Supabase Database Backup - PRODUCTION
on:
  schedule:
    - cron: '0 2 * * *'  # Chaque nuit Ã  2h00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
      
      - name: Create backup directory
        run: |
          BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
          mkdir -p $BACKUP_DIR
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
          echo "BACKUP_DATE=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
      
      - name: ðŸ”’ Backup database schema (structure)
        run: |
          echo "ðŸ“¦ Backing up database schema..."
          supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" --schema public --schema-only > $BACKUP_DIR/schema.sql
          echo "âœ… Schema backup completed"
      
      - name: ðŸ“Š Backup database data (donnÃ©es mÃ©tier)
        run: |
          echo "ðŸ“¦ Backing up database data..."
          supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" --schema public --data-only > $BACKUP_DIR/data.sql
          echo "âœ… Data backup completed"
      
      - name: ðŸ‘¥ Backup auth users (utilisateurs)
        run: |
          echo "ðŸ“¦ Backing up auth users..."
          supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" --schema auth --data-only > $BACKUP_DIR/auth_users.sql
          echo "âœ… Auth users backup completed"
      
      - name: ðŸ“ Create restoration guide
        run: |
          cat > $BACKUP_DIR/RESTORE.md << 'EOF'
          # ðŸ”„ GUIDE DE RESTAURATION - ACLEF PÃ©dagogie

          **Date du backup :** ${{ env.BACKUP_DATE }}
          **Projet Supabase :** mkbchdhbgdynxwfhpxbw
          **Statut :** PRODUCTION

          ---

          ## ðŸ“¦ CONTENU DE CE BACKUP

          - `schema.sql` - Structure complÃ¨te de la base (tables, contraintes, RLS, functions)
          - `data.sql` - Toutes les donnÃ©es mÃ©tier (users, planning, textes, etc.)
          - `auth_users.sql` - Comptes utilisateurs et authentification
          - `RESTORE.md` - Ce guide

          ---

          ## âš ï¸ SCÃ‰NARIOS DE RESTAURATION

          ### ScÃ©nario A : Restauration sur le MÃŠME projet (Transparent)

          **Utiliser quand :**
          - Erreur humaine (DELETE accidentel, UPDATE destructeur)
          - Migration ratÃ©e
          - Corruption de donnÃ©es
          - Erreur de Claude Code

          **ProcÃ©dure :**

          ```bash
          # 1. Se connecter au projet actuel
          export DB_URL="${{ secrets.SUPABASE_DB_URL }}"

          # 2. Restaurer la structure
          psql $DB_URL < schema.sql

          # 3. Restaurer les donnÃ©es mÃ©tier
          psql $DB_URL < data.sql

          # 4. Restaurer les utilisateurs
          psql $DB_URL < auth_users.sql
          ```

          **RÃ©sultat :**
          - âœ… **Restauration transparente**
          - âœ… Application continue de fonctionner
          - âœ… Aucun changement d'URL
          - âœ… Aucune intervention sur l'application
          - â±ï¸ Temps : 10-15 minutes

          ---

          ### ScÃ©nario B : Restauration sur un NOUVEAU projet (RedÃ©ploiement)

          **Utiliser quand :**
          - Projet Supabase dÃ©truit/supprimÃ©
          - Compte piratÃ©
          - Catastrophe totale
          - Migration vers nouveau projet

          **ProcÃ©dure :**

          ```bash
          # 1. CrÃ©er un nouveau projet Supabase
          # Via https://supabase.com/dashboard
          # Notez le nouveau project-ref : XXXXXXX

          # 2. RÃ©cupÃ©rer la nouvelle URL de connexion
          # Settings > Database > Connection Pooling
          export NEW_DB_URL="postgresql://postgres.XXXXXXX:[PASSWORD]@aws-1-eu-west-3.pooler.supabase.com:5432/postgres"

          # 3. Restaurer la structure
          psql $NEW_DB_URL < schema.sql

          # 4. Restaurer les donnÃ©es
          psql $NEW_DB_URL < data.sql

          # 5. Restaurer les utilisateurs
          psql $NEW_DB_URL < auth_users.sql

          # 6. Mettre Ã  jour les variables d'environnement
          # Fichier : .env.local ou .env.production
          NEXT_PUBLIC_SUPABASE_URL=https://XXXXXXX.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY=[nouvelle_anon_key]
          SUPABASE_SERVICE_ROLE_KEY=[nouvelle_service_role_key]

          # 7. RedÃ©ployer l'application
          vercel --prod  # ou votre mÃ©thode de dÃ©ploiement
          ```

          **RÃ©sultat :**
          - âœ… Toutes les donnÃ©es restaurÃ©es
          - âœ… Tous les utilisateurs conservÃ©s
          - âš ï¸ Nouvelle URL (changement unique)
          - âš ï¸ RedÃ©ploiement nÃ©cessaire
          - â±ï¸ Temps : 30-45 minutes

          ---

          ## ðŸ”’ CE QUI EST PROTÃ‰GÃ‰

          ### Protection Totale (Restauration Transparente) :
          - âœ… DELETE accidentel
          - âœ… UPDATE destructeur
          - âœ… DROP TABLE par erreur
          - âœ… Migration ratÃ©e
          - âœ… Corruption de donnÃ©es
          - âœ… Erreur de Claude Code
          - âœ… Modification RLS incorrecte

          ### Protection ComplÃ¨te (Restauration avec RedÃ©ploiement) :
          - âœ… Projet Supabase supprimÃ©
          - âœ… Compte piratÃ©
          - âœ… Catastrophe technique
          - âœ… Malveillance extÃ©rieure

          ---

          ## â±ï¸ CALENDRIER DES BACKUPS

          - **FrÃ©quence :** Chaque nuit Ã  2h00 UTC (3h00 Paris)
          - **RÃ©tention :** 7 derniers backups conservÃ©s
          - **Perte maximale :** 24 heures de donnÃ©es

          ---

          ## ðŸ“Š INFORMATIONS TECHNIQUES

          **Tailles estimÃ©es :**
          - schema.sql : 10-50 Ko
          - data.sql : 500 Ko - 2 Mo
          - auth_users.sql : 5-20 Ko

          **Tables sauvegardÃ©es :** 50+ tables
          **Lignes estimÃ©es :** 2000+ lignes
          **Utilisateurs :** Tous les comptes auth

          ---

          ## ðŸ†˜ EN CAS D'URGENCE

          1. **Identifier le problÃ¨me**
          2. **Choisir le bon scÃ©nario** (A ou B)
          3. **Trouver le dernier backup valide** (avant l'incident)
          4. **Suivre la procÃ©dure** Ã©tape par Ã©tape
          5. **VÃ©rifier** que l'application fonctionne
          6. **Tester** une connexion utilisateur

          ---

          ## âœ… CHECKLIST POST-RESTAURATION

          - [ ] Base de donnÃ©es restaurÃ©e
          - [ ] SchÃ©ma complet prÃ©sent
          - [ ] DonnÃ©es visibles dans l'app
          - [ ] Connexion utilisateur fonctionnelle
          - [ ] RLS policies actives
          - [ ] Application accessible
          - [ ] Tests de base rÃ©ussis

          ---

          **Ce backup protÃ¨ge votre production contre toute catastrophe ! ðŸ›¡ï¸**
          EOF
      
      - name: ðŸ“ˆ Show backup summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… BACKUP COMPLET PRODUCTION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ Backup directory: $BACKUP_DIR"
          echo ""
          echo "ðŸ“¦ Files created:"
          ls -lh $BACKUP_DIR/
          echo ""
          echo "ðŸ“Š File sizes:"
          du -h $BACKUP_DIR/*
          echo ""
          echo "ðŸ“ Line counts:"
          wc -l $BACKUP_DIR/*.sql $BACKUP_DIR/*.md
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ðŸ’¾ Commit and push backup
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add backups/
          git commit -m "ðŸ’¾ Backup PRODUCTION $(date '+%Y-%m-%d %H:%M:%S')

          âœ… Schema (structure)
          âœ… Data (donnÃ©es mÃ©tier)  
          âœ… Auth users (utilisateurs)
          âœ… RESTORE.md (guide)
          
          ðŸ¤– Generated with Claude Code" || exit 0
          git push
      
      - name: ðŸ§¹ Cleanup old backups (keep last 7)
        run: |
          cd backups
          # Compter les backups
          BACKUP_COUNT=$(ls -d */ 2>/dev/null | wc -l)
          echo "ðŸ“Š Total backups: $BACKUP_COUNT"
          
          if [ $BACKUP_COUNT -gt 7 ]; then
            echo "ðŸ§¹ Cleaning old backups (keeping last 7)..."
            ls -dt */ | tail -n +8 | xargs rm -rf
            git add .
            git commit -m "ðŸ§¹ Cleanup: Keep last 7 backups" || exit 0
            git push
          else
            echo "âœ… No cleanup needed ($BACKUP_COUNT backups)"
          fi
